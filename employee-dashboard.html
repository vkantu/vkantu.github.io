<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Dashboard | RK TECHNOLOGIES</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    .dashboard-section {
      max-width: 1100px;
      margin: auto;
      padding: 40px 20px;
    }

    .dashboard-card {
      background: #ffffff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .dashboard-meta {
      font-size: 14px;
      color: #666;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .profile-item {
      background: #f8f9fb;
      padding: 14px;
      border-radius: 8px;
      border: 1px solid #e6e6e6;
    }

    .profile-item h4 {
      margin: 0 0 6px;
      font-size: 13px;
      color: #444;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .profile-item p {
      margin: 0;
      font-size: 15px;
      color: #111;
      font-weight: 600;
    }

    .dashboard-message {
      margin: 12px 0 0;
      font-size: 14px;
    }

    .task-list {
      margin-top: 20px;
      display: grid;
      gap: 14px;
    }

    .task-item {
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 16px;
      background: #fafafa;
    }

    .task-item h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .task-meta {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
    }

    .task-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .task-form label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
    }

    .task-form input,
    .task-form select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #d4d4d4;
      font-size: 13px;
    }

    .task-actions {
      display: flex;
      align-items: end;
    }
  </style>
</head>
<body>

<!-- Navigation -->
<nav class="fade-down navbar dark">

  <div class="nav-left">
    <div class="nav-logo">
      <a href="index.html">
        <img src="/logo.png" alt="RK Technologies Logo">
      </a>
    </div>

    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="about.html">About Us</a>
      <a href="services.html">Services</a>
      <a href="careers.html">Careers</a>
      <a href="contact.html">Contact Us</a>
    </div>
  </div>

  <div class="nav-right">
    <button id="employee-signout" class="btn btn-login">
      <i class="fas fa-right-from-bracket"></i> Sign Out
    </button>
  </div>

</nav>

<!-- Hero -->
<header class="hero">
  <div class="hero-content">
    <h1 class="hero-title">Employee Dashboard</h1>
    <p class="dashboard-meta" id="employee-session-email"></p>
  </div>
</header>

<section class="dashboard-section fade-up">
  <div class="dashboard-card">
    <div class="dashboard-header">
      <div>
        <h2>Your Profile</h2>
        <p class="dashboard-meta">Employee details from the HR system.</p>
      </div>
    </div>

    <div id="profile-content">
      <p class="dashboard-message">Loading your profile...</p>
    </div>
    <p id="profile-message" class="dashboard-message"></p>
  </div>

  <div class="dashboard-card" style="margin-top: 24px;">
    <div class="dashboard-header">
      <div>
        <h2>Your Tasks</h2>
        <p class="dashboard-meta" id="task-count">Loading tasks...</p>
      </div>
    </div>

    <div id="task-list" class="task-list">
      <p class="dashboard-message">Loading tasks...</p>
    </div>
    <p id="task-message" class="dashboard-message"></p>
  </div>
</section>

<!-- Footer -->
<footer>
  <p>© 2026 RK TECHNOLOGIES INC. All rights reserved.</p>
</footer>

<script src="nav.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://rabqlsxqhjslykytnqay.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_j9qSr64uhVKZgG8jTnjj6g_h2ZygZNp";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const profileContent = document.getElementById("profile-content");
  const profileMessage = document.getElementById("profile-message");
  const taskList = document.getElementById("task-list");
  const taskMessage = document.getElementById("task-message");
  const taskCount = document.getElementById("task-count");
  const sessionEmail = document.getElementById("employee-session-email");
  const signOutBtn = document.getElementById("employee-signout");

  const setMessage = (text, isError = false) => {
    profileMessage.textContent = text;
    profileMessage.style.color = isError ? "#c0392b" : "#1b7f3a";
  };

  const setTaskMessage = (text, isError = false) => {
    taskMessage.textContent = text;
    taskMessage.style.color = isError ? "#c0392b" : "#1b7f3a";
  };

  const renderProfile = (employee) => {
    const hireDate = employee.hire_date ? new Date(employee.hire_date).toLocaleDateString() : "—";
    profileContent.innerHTML = `
      <div class="profile-grid">
        <div class="profile-item">
          <h4>Full Name</h4>
          <p>${employee.full_name || "—"}</p>
        </div>
        <div class="profile-item">
          <h4>Email</h4>
          <p>${employee.email || "—"}</p>
        </div>
        <div class="profile-item">
          <h4>Role</h4>
          <p>${employee.role || "—"}</p>
        </div>
        <div class="profile-item">
          <h4>Department</h4>
          <p>${employee.department || "—"}</p>
        </div>
        <div class="profile-item">
          <h4>Location</h4>
          <p>${employee.location || "—"}</p>
        </div>
        <div class="profile-item">
          <h4>Status</h4>
          <p>${employee.status || "Active"}</p>
        </div>
        <div class="profile-item">
          <h4>Hire Date</h4>
          <p>${hireDate}</p>
        </div>
      </div>
    `;
  };

  const loadProfile = async (email) => {
    setMessage("");
    profileContent.innerHTML = "<p class=\"dashboard-message\">Loading your profile...</p>";

    const { data, error } = await supabaseClient
      .from("employees")
      .select("full_name, email, role, department, location, status, hire_date")
      .eq("email", email)
      .maybeSingle();

    if (error) {
      profileContent.innerHTML = "<p class=\"dashboard-message\">Unable to load profile.</p>";
      setMessage(error.message || "Could not load profile.", true);
      return;
    }

    if (!data) {
      profileContent.innerHTML = "<p class=\"dashboard-message\">No employee record found.</p>";
      setMessage("Ask HR to add your employee record.", true);
      return;
    }

    renderProfile(data);
  };

  const renderTasks = (tasks) => {
    if (!tasks.length) {
      taskList.innerHTML = "<p class=\"dashboard-message\">No tasks assigned.</p>";
      taskCount.textContent = "0 tasks";
      return;
    }

    taskCount.textContent = `${tasks.length} task${tasks.length === 1 ? "" : "s"}`;
    taskList.innerHTML = tasks.map((task) => {
      const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString() : "—";
      const endDateValue = task.end_date ? new Date(task.end_date).toISOString().split("T")[0] : "";
      const remarksValue = task.remarks || "";
      return `
        <div class="task-item" data-task-id="${task.id}">
          <h3>${task.title || "Task"}</h3>
          <p class="task-meta">${task.description || ""}</p>
          <p class="task-meta">Due: ${dueDate}</p>

          <div class="task-form">
            <div>
              <label>Status</label>
              <select class="task-status">
                <option value="Open" ${task.status === "Open" ? "selected" : ""}>Open</option>
                <option value="In Progress" ${task.status === "In Progress" ? "selected" : ""}>In Progress</option>
                <option value="Finished" ${task.status === "Finished" ? "selected" : ""}>Finished</option>
              </select>
            </div>
            <div>
              <label>End Date</label>
              <input type="date" class="task-end-date" value="${endDateValue}">
            </div>
            <div>
              <label>Remarks</label>
              <input type="text" class="task-remarks" value="${remarksValue}" placeholder="Add remarks">
            </div>
            <div class="task-actions">
              <button type="button" class="btn btn-primary task-save">Save</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  };

  const loadTasks = async (email) => {
    setTaskMessage("");
    taskList.innerHTML = "<p class=\"dashboard-message\">Loading tasks...</p>";

    const { data, error } = await supabaseClient
      .from("tasks")
      .select("id, title, description, due_date, status, remarks, end_date")
      .eq("assignee_email", email)
      .order("due_date", { ascending: true });

    if (error) {
      taskList.innerHTML = "<p class=\"dashboard-message\">Unable to load tasks.</p>";
      setTaskMessage(error.message || "Could not load tasks.", true);
      taskCount.textContent = "—";
      return;
    }

    renderTasks(data || []);
  };

  const saveTaskUpdate = async (taskId, status, endDate, remarks) => {
    const { error } = await supabaseClient
      .from("tasks")
      .update({
        status,
        end_date: endDate || null,
        remarks: remarks || null,
      })
      .eq("id", taskId);

    if (error) {
      setTaskMessage(error.message || "Unable to update task.", true);
      return false;
    }
    setTaskMessage("Task updated.");
    return true;
  };

  const ensureSession = async () => {
    const { data } = await supabaseClient.auth.getSession();
    if (!data.session) {
      const { data: authListener } = supabaseClient.auth.onAuthStateChange((_event, session) => {
        if (session) {
          sessionEmail.textContent = `Signed in as ${session.user.email}`;
          loadProfile(session.user.email);
          loadTasks(session.user.email);
        }
      });

      setTimeout(() => {
        authListener.subscription.unsubscribe();
        window.location.href = "employee-login.html";
      }, 800);
      return;
    }
    sessionEmail.textContent = `Signed in as ${data.session.user.email}`;
    await loadProfile(data.session.user.email);
    await loadTasks(data.session.user.email);
  };

  signOutBtn.addEventListener("click", async () => {
    await supabaseClient.auth.signOut();
    window.location.href = "employee-login.html";
  });

  taskList.addEventListener("click", async (event) => {
    const target = event.target;
    if (!target.classList.contains("task-save")) return;

    const taskItem = target.closest(".task-item");
    if (!taskItem) return;

    const taskId = taskItem.getAttribute("data-task-id");
    const status = taskItem.querySelector(".task-status").value;
    const endDate = taskItem.querySelector(".task-end-date").value;
    const remarks = taskItem.querySelector(".task-remarks").value.trim();

    await saveTaskUpdate(taskId, status, endDate, remarks);
  });

  ensureSession();
</script>
</body>
</html>
